---
title: "groot test"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(stringr)
source_rmd <- function(file_path) {
  stopifnot(is.character(file_path) && length(file_path) == 1)
  .tmpfile <- tempfile(fileext = ".R")
  .con <- file(.tmpfile)
  on.exit(close(.con))
  full_rmd <- read_file(file_path)
  codes <- str_match_all(string = full_rmd, pattern = "```(?s)\\{r[^{}]*\\}\\s*\\n(.*?)```")
  stopifnot(length(codes) == 1 && ncol(codes[[1]]) == 2)
  codes <- paste(codes[[1]][, 2], collapse = "\n")
  writeLines(codes, .con)
  flush(.con)
  cat(sprintf("R code extracted to tempfile: %s\nSourcing tempfile...", .tmpfile))
  source(.tmpfile)
}

```

```{r load, include = FALSE, cache=TRUE}
source_rmd("paper_reimplentation.Rmd")
```

```{r}
library(tidyverse)
library(psych)
library(FactoMineR)
```

```{r}
groot <- read_csv("GRooTAggregateSpeciesVersion.csv")
```

```{r}
groot_w <- groot %>% 
  mutate(species = paste(genusTNRS, speciesTNRS)) %>% 
  select(species, traitName, meanSpecies) %>% 
  pivot_wider(names_from = traitName, values_from = meanSpecies)
```

```{r}
groot_w %>% 
  drop_na()
```
```{r}
miss_traits <- groot_w %>% 
  select(-species) %>% 
  is.na() %>% 
  colSums() %>% 
  as.data.frame() %>%
  transmute(perc_na = ./nrow(groot_w) * 100) %>% 
  rownames_to_column(var = "trait") %>% 
  mutate(trait = fct_reorder(trait, perc_na))
```

```{r}
ggplot(miss_traits, aes(perc_na, trait)) +
  geom_bar(stat="identity") +
  labs(x="Percentage of missing data", y="Trait")
```
```{r}
top <- head(sort(miss_traits$trait),8)
```
```{r}
groot_w %>% 
  select(all_of(top)) %>% 
  drop_na() %>% 
  nrow()
```
```{r}
#table(groot_w$species %in% plants$species)
```

```{r}
top4 <- head(sort(miss_traits$trait),5)
```
```{r}
groot_w %>% 
  select(all_of(top), -`Root_mycorrhizal colonization` ) %>% 
  drop_na() %>% 
  nrow()
```
```{r}
top
```

```{r}
groot_t4 <- select(groot_w, all_of(top4), -`Root_mycorrhizal colonization` ) %>% 
  drop_na()
```

```{r}
pairs.panels(groot_t4,
density = FALSE, ellipses = FALSE, hist.col = "grey")
```

```{r}
groot_t4l <- map_df(groot_t4, ~log10(.) %>% scale())
```
```{r}
pairs.panels(groot_t4l,
density = FALSE, ellipses = FALSE, hist.col = "grey")
```


```{r}
pca_t4 <- PCA(groot_t4l)
```
```{r}
plot(pca_t4, label = "none")
```


```{r}
summary(pca_t4)
```


```{r}
groot_t4$`Root_mycorrhizal colonization`
```



## Check whether Fabaceae are responsible for points in the upper left corner
```{r}
groot <- read.csv(here::here("big_groot_correct_names.csv"))
```

```{r}
gift_family <- read_rds(here::here("20210706_GIFT_family.rds"))
str(gift_family)
```

```{r}
gift_family <- gift_family %>%
  mutate(species = paste(genus, species, sep = " "))
length(unique(gift_family$species))
```

```{r}
groot_family <- inner_join(groot, gift_family, by = "species")

top3 <- c("Specific_root_length", "Root_N_concentration", "Mean_Root_diameter", "Root_tissue_density")

groot_t3 <- select(groot_family, all_of(top3)) %>%
  drop_na()

groot_t3l <- map_df(groot_t3, ~log10(.) %>% scale())

pca_t3 <- PCA(groot_t3l)
```


```{r}
pca3_coords <- as.data.frame(pca_t3$ind$coord)

groot_t3_sp <- select(groot_family, all_of(top3), family) %>%
  drop_na()

faba <- ifelse(groot_t3_sp$family == "Leguminosae", "Fabaceae", "other")

ggplot(pca3_coords, aes(Dim.1, Dim.2, colour=faba)) +
  geom_point() +
  scale_color_manual(values = c("Fabaceae" = "green", "other" = "grey"))
```

