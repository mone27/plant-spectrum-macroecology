---
title: "R Notebook"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: inline
---

```{r}
library(tidyverse)
library(FactoMineR)
library(psych)
```

```{r}
plants_all <- read_rds(here::here("try_diaz_traits_sp_mean.Rds"))

names(plants_all) <- c("species", "LA", "LMA", "N", "phot_path", "H", "SM", "SSD")

plants_all$LMA <- 1 / plants_all$LMA # in the data set it is SLA which is the opposite of LMA 

#replaces NaN with NAs for consistency later
is.nan.data.frame <- function(x)
  do.call(cbind, lapply(x, is.nan))

# complete dataset
plants_all[is.nan(plants_all)] <- NA

# removes NA values
plants <- select(plants_all, -"phot_path") %>% 
  drop_na() %>% 
  filter(SSD>0) # remove platns with 0 SSD

plants_pca <- select(plants, -species) # without species col so can be used in PCA directly
```


# Missing traits

```{r}
miss_traits_plants <- select(plants_all, -species) %>% 
  is.na() %>% 
  colSums() %>% 
  as.data.frame() %>%
  transmute(perc_na = ./nrow(plants_all) * 100) %>% 
  rownames_to_column(var = "trait") %>% 
  mutate(trait = fct_reorder(trait, perc_na))
```
```{r}
ggplot(miss_traits_plants, aes(perc_na, trait)) +
  geom_bar(stat="identity") +
  labs(x="Percentage of missing data", y="Trait")
```


# First look at data

```{r}
pairs.panels(plants_pca,
density = FALSE, ellipses = FALSE, hist.col = "grey")
```
Trying to fir the first PCA
```{r}
pca1 <- PCA(plants_pca)
```

# Remove outliers

Here we are removing the 4 species with the highest value of Leaf Area, as they are very different from the average
```{r}
arrange(plants, desc(LA)) %>%  #remove first four species
  select(species, LA)
```
```{r}
plants2 <- plants %>%
  filter(!species %in% c("Licania micrantha", "Iriartea deltoidea", "Socratea exorrhiza", "Oenocarpus mapora", "Cecropia insignis"))
```

```{r}
plants_pca2 <- select(plants2, -species)

pairs.panels(plants_pca2,
density = FALSE, ellipses = FALSE, hist.col = "grey")

pca2 <- PCA(plants_pca2)
```


# Log transform and normalize data


```{r}
plants_pca3 <- map_df(plants_pca2, ~log10(.) %>% scale())
plants3 <- cbind(species = plants2$species, plants_pca3)
```

```{r}
pairs.panels(plants_pca3,
density = FALSE, ellipses = FALSE, hist.col = "grey")
```
```{r}
pca3 <- PCA(plants_pca3)
plot.PCA(pca3, choix = "var")
plot.PCA(pca3, choix = "ind", label = "none")
```

```{r}
summary(pca3)
```


# divide plants into woody and non-woody plants

```{r}
ggplot() +
  geom_histogram(aes(H), data = plants, bins=25)
```

take threshold of 1.5m for woody plants (arbitrary value)

plot the PCA result separating woody and non woddy plants
```{r}
pca3_coords <- as.data.frame(pca3$ind$coord)

woody <- ifelse(plants_pca2$H>1.5, "woody", "non-woody")

ggplot(pca3_coords, aes(Dim.1, Dim.2, colour=woody)) +
  geom_point() +
  scale_color_manual(values = c("woody" = "brown", "non-woody" = "green"))
```





