---
title: "TermPaper"
output:
  pdf_document: default
  html_notebook: default
---
```{r}
library(tidyverse)
library(patchwork)
library(GGally)
library(ggrepel)
library(ggforce)
library(ggtext)
theme_set(theme_bw())
```

Source functions and notebooks
```{r}
source("Plant_spectrum_functions.R") # this should not be cached
```

```{r, results='hide', include=FALSE,fig.show='hide', cache=TRUE}
source_rmd("TRY_analysis.Rmd")
source_rmd("GRooT_analysis.Rmd")
source_rmd("GIFT_analysis.Rmd")
```


Load data


plots/tables: traits/trait selection, missing traits, TRY pair plot, TRY PCA, GRooT PCA, TGG pair plot, TGG PCoA, TGG woody/non-woody

Missing traits (GRooT)
```{r}
missing_traits(groot) %>% 
  arrange(perc_na) %>% 
  head(15) %>% 
  # mutate(traitfull = ifelse(trait %in% "Mean_Root_diameter",
  #                       str_glue("<b style='color:#006633;'>{trait}</b>"),
  #                       str_glue("<p style='color:#000000;'>{trait}</p>"))) %>% 
  plot_missing_traits() +
  labs(title = "GRooT") +
  # theme(axis.text.y = element_markdown())
  # geom_mark_rect(aes(x,y, label=label), 
  #                data = expand_grid(
  #                  x = c(0, 80), y=c(2,3,4,5), label="Selected traits")) # traits of interest
```

TRY
  Trait selection
  Merged datasets
  
  Pair plot
```{r}
pair_plots(TRY_pca)
```

  PCA
```{r, cache=TRUE}
try_pca <- ps_pca(TRY3) #slow!
```


```{r}
plot_pcoa(try_pca, TRY3)
```
  
GrooT
  Trait selection
  Merged datasets
  PCA
  
```{r, cache=TRUE}
groot_t4l <- groot_t4l %>% 
  mutate(species = NA) %>% # rename variables to improve plotting
  rename(R_TD = "Root_tissue_density", R_diam = "Mean_Root_diameter",
         SRL = "Specific_root_length", R_N = "Root_N_concentration")

groot_pca <- groot_t4l %>% 
  ps_pca() #slow!
```


```{r}
plot_pcoa(groot_pca, groot_t4l)
```
GIft ?
  Trait selection
  Merged datasets
  PCoA
TGG
  Trait selection
  Merged datasets
  PCA/PCoA

```{r, results='hide', include=FALSE,fig.show='hide', cache=TRUE}
source_rmd("TRY_Gift_GRooT_analysis.Rmd")
```


```{r}
tgg_pcoa_data %>% 
  select(!where(is.character)) %>% 
  pair_plots()
```

```{r}
plot_pcoa_cat(tgg_pcoa, try_gift_groot) +
  theme(legend.position = c(0.1, 0.79))
```

```{r}
tgg_tree <- try_gift_groot %>% 
  filter(growth_form == "tree")

tgg_ntree <- try_gift_groot %>% 
  filter(growth_form != "tree")
```

```{r, fig.dim = c(8, 12)}
# This looks bad in markdown but it is okay in the PDF output
tgg_tree_plot <- tgg_tree %>% 
  pcoa_gower() %>% 
  plot_pcoa_cat(tgg_tree) +
  labs(title = "(a) Trees")
#  theme(legend.position = c(0.1, 0.79))

tgg_ntree_plot <- tgg_ntree %>% 
  pcoa_gower() %>% 
  plot_pcoa_cat(tgg_ntree) +
  labs(title="(b) Non Trees") 
#  theme(legend.position = c(0.1, 0.79))

tgg_tree_plot / tgg_ntree_plot +
  plot_layout(guide = "collect") &
  theme(legend.position='bottom')
```
